import{mean,ascending,quantileSorted,extent,min}from"d3-array";import{select,selectAll}from"d3-selection";import{line}from"d3-shape";import{v4}from"uuid";class Draft{constructor(){this._id="chart"+v4(),this._include=null,this._exclude=null,this._layer}chart(e){return this._chart=select(e),this._chart.append("g").attr("id","draughty"),this}layer(e){return this._layer=e,this}select(e){return this._selector=e,this._selection=this._chart.selectAll(e),this._data=this._selection.data(),this._stats=this._getStats(this._data),this}selection(e){return this._selection=e,this._data=e.data(),this._stats=this._getStats(this._data),this}data(e){return this._data=e,this}x(e,t){return this._xVar=e,this._xScale=t,this}y(e,t){return this._yVar=e,this._yScale=t,this}include(e){return this._include=e,this}exclude(e){return this._exclude=e,this}_handleLine(r,e,t){if(1<=e.length){var i=t.selectAll("#"+r.id).data(e).join("line").attr("id",r.id).attr("x1",e=>e.x1).attr("y1",e=>e.y1).attr("x2",e=>e.x2).attr("y2",e=>e.y2);for(let s of Object.keys(r.styles))i.attr(s,(e,t)=>{var i=r.styles[s];return"function"==typeof i?i(e,t):i})}else t.selectAll("#"+r.id).data(e).join("line").attr("id",r.id)}_handleRect(r,e,t){if(1<=e.length){var i=t.selectAll("#"+r.id).data(e).join("rect").attr("id",r.id).attr("x",e=>e.x).attr("width",e=>e.width).attr("y",e=>e.y).attr("height",e=>e.height);for(let s of Object.keys(r.styles))i.attr(s,(e,t)=>{var i=r.styles[s];return"function"==typeof i?i(e,t):i})}else t.selectAll("#"+r.id).data(e).join("line").attr("id",r.id)}_handleText(r,e,t){var i;if(0<e.length){i=t.selectAll("#"+r.id).data(e).join("text").attr("id",r.id).attr("x",e=>e.x).attr("y",e=>e.y).attr("font-family","sans-serif").attr("font-size",11).attr("alignment-baseline",e=>e.baseline||"middle").attr("text-anchor",e=>e.anchor||"start").attr("xml:space","preserve").text(e=>e.text);for(let s of Object.keys(r.styles))"text"===s?i.text((e,t)=>{var i=r.styles[s];return"function"==typeof i?i(e,t):i}):i.attr(s,(e,t)=>{var i=r.styles[s];return"function"==typeof i?i(e,t):i})}else t.selectAll("#"+r.id).data(e).join("text").attr("id",r.id)}_handleMarkMultiple(r,e,t,i=!0){let s=this._selection.nodes(),a;a=Array.isArray(e[0])&&s[0].nodeName.startsWith("path")?e[0][0].x&&!e[0][0].y?t.selectAll(`.${r.id}_multiple`).data(e).join(e=>e.append((e,t)=>(i?s[t]:s[0]).cloneNode(!0))).attr("class",r.id+"_multiple").attr("d",(e,t)=>line().x(e=>e.x).y(e=>this._yScale(e[this._yVar]))(e)):e[0][0].y&&!e[0][0].x?t.selectAll(`.${r.id}_multiple`).data(e).join(e=>e.append((e,t)=>(i?s[t]:s[0]).cloneNode(!0))).attr("class",r.id+"_multiple").attr("d",(e,t)=>line().x(e=>this._xScale(e[this._xVar])).y(e=>e.y)(e)):t.selectAll(`.${r.id}_multiple`).data(e).join(e=>e.append((e,t)=>(i?s[t]:s[0]).cloneNode(!0))).attr("d",(e,t)=>line().x(e=>e.x).y(e=>e.y)):e[0].x&&!e[0].y?t.selectAll(`.${r.id}_multiple`).data(e).join(e=>e.append((e,t)=>(i?s[t]:s[0]).cloneNode(!0))).attr("class",r.id+"_multiple").attr("cx",(e,t)=>{if(s[t].cx)return null!=e.deltx?s[t].cx.baseVal.value+e.deltx:e.x}).attr("x",(e,t)=>{if(s[t].x)return null!=e.deltx?s[t].x.baseVal.value+e.deltx:e.x}).attr("width",(e,t)=>{if(s[t].width)return null!=e.deltx?s[t].width.baseVal.value+e.deltx:e.x}):e[0].y&&!e[0].x?t.selectAll(`.${r.id}_multiple`).data(e).join(e=>e.append((e,t)=>(i?s[t]:s[0]).cloneNode(!0))).attr("class",r.id+"_multiple").attr("cy",(e,t)=>{if(s[t].cy)return null!=e.delty?s[t].cy.baseVal.value+e.delty:e.y}).attr("y",(e,t)=>{if(s[t].y)return null!=e.delty?s[t].y.baseVal.value+e.delty:e.y}).attr("height",(e,t)=>{if(s[t].height)return null!=e.delty?s[t].height.baseVal.value-e.delty:e.y}):t.selectAll(`.${r.id}_multiple`).data(e).join(e=>e.append((e,t)=>(i?s[t]:s[0]).cloneNode(!0))).attr("cx",(e,t)=>{if(s[t].cx)return null!=e.deltx?s[t].cx.baseVal.value+e.deltx:e.x}).attr("x",(e,t)=>{if(s[t].x)return null!=e.deltx?s[t].x.baseVal.value+e.deltx:e.x}).attr("width",(e,t)=>{if(s[t].width)return null!=e.deltx?s[t].width.baseVal.value+e.deltx:e.x}).attr("cy",(e,t)=>{if(s[t].cy)return null!=e.delty?s[t].cy.baseVal.value+e.delty:e.y}).attr("y",(e,t)=>{if(s[t].y)return null!=e.delty?s[t].y.baseVal.value+e.delty:e.y}).attr("height",(e,t)=>{if(s[t].height)return null!=e.delty?s[t].height.baseVal.value-e.delty:e.y});for(let s of Object.keys(r.styles))a.attr(s,(e,t)=>{var i=r.styles[s];return"function"==typeof i?i(e,t):i})}_round(e){return Math.round(100*e)/100}_getStats(e){if(0===e.length)return{};var i={};for(let t of Object.keys(e[0])){var s,r,a,n,l,h,_,o=this._round(mean(e,e=>e[t]));o&&(l=e.map(e=>e[t]).sort(ascending),s=this._round(quantileSorted(l,.5)),r=this._round(quantileSorted(l,.75)),a=this._round(quantileSorted(l,.25)),n=l[0],l=l[l.length-1],h=this._round(a-1.5*(r-a)),_=this._round(r+1.5*(r-a)),i[t]={min:n,Q1:a,mean:o,median:s,Q3:r,max:l,lowerBound:h,upperBound:_})}return i}augment(e){let t=e;var i=this._chart.select(this._layer||"#draughty");0===e.length&&selectAll(`${this._layer||"#draughty"} > *`).remove(),this._exclude&&this._exclude.rank?t=t.filter(e=>e.rank<=this._exclude.rank):this._include&&this._include.rank&&(t=t.filter(e=>e.rank<=this._include.rank));for(let l of t){var s=l.selection&&0<l.selection.size()?l.selection:this._selection,r=l.selection&&0<l.selection.size()?l.selection.data():this._data;let n=l.selection&&0<l.selection.size()?this._getStats(r):this._stats;if(this._exclude&&this._exclude.type){if(0<=this._exclude.type.indexOf(l.type))continue}else if(this._include&&this._include.type&&-1===this._include.type.indexOf(l.type))continue;if(this._exclude&&this._exclude.name){if(0<=this._exclude.name.indexOf(l.name.split("_")[1]))continue}else if(this._include&&this._include.name&&-1===this._include.name.indexOf(l.name.split("_")[1]))continue;if("encoding"===l.type){var h=l.name.split("_")[1];let a=l.styles;for(let r of Object.keys(a))this._selection&&this._selection.style(r,void 0),r.startsWith(h)&&("opacity"===r?s.style(r,(e,t,i)=>{var s;return l.generator(e,this._xVar,this._yVar,this._xScale,this._yScale,n)?"function"==typeof(s=a[r])?s(e,t):s:.25}):s.style(r,(e,t)=>{var i;if(l.generator(e,this._xVar,this._yVar,this._xScale,this._yScale,n))return"function"==typeof(i=a[r])?i(e,t):i}))}else"mark"===l.type&&((r=l.generator(r,this._xVar,this._yVar,this._xScale,this._yScale,n))&&"line"===l.encoding.mark?this._handleLine(l,r,i):r&&"text"===l.encoding.mark?this._handleText(l,r,i):r&&"rect"===l.encoding.mark?this._handleRect(l,r,i):r&&!l.encoding.mark&&(l.name.endsWith("multiple")?this._handleMarkMultiple(l,r,i):this._handleMarkMultiple(l,r,i,!1)))}return this}}class Aug{constructor(e,t="",i="",s={},r,a,n,l){this._id=e,this._name=t,this._type=i,this._encoding=s,this._generator=r,this._styles=a,this._rank=l,this._selection=n}getSpec(){return{id:this._id,name:this._name,type:this._type,encoding:this._encoding,generator:this._generator,styles:this._styles,rank:this._rank,selection:this._selection}}}class GenerationCriteriaBase{constructor(){this._id="df"+v4(),this._name="DFBase",this._selection}selection(e){return this._selection=e,this}select(e){return this._selection=selectAll(e),this}include(e){return this._include=e,this}exclude(e){return this._exclude=e,this}mergeStyles(e,t){if(e&&!t)return e;if(!e&&t)return t;if(e&&t){var i,s={};for(i of Array.from(new Set(Object.keys(t).concat(Object.keys(e)))))s[i]=e[i]||t[i];return s}return{}}_updateStyles(e,t){if(!t)return{};var i,s=JSON.parse(JSON.stringify(e));for(i of Object.keys(t))s[i]=t[i];return s}updateStyles(e,t=!1){return this._customStyles=t?e:this._updateStyles(this._customStyles,e),this}_sort(e,t){return t.rank-e.rank}_filter(e){let t=e;return this._exclude?(this._exclude.rank&&(t=t.filter(e=>e.rank<=this._exclude.rank)),this._exclude.type&&(t=t.filter(e=>this._exclude.type.indexOf(e.type)<0)),this._exclude.name&&(t=t.filter(e=>this._exclude.name.indexOf(e.name.split("_")[1])<0))):this._include&&this._include.name&&(this._include.rank&&(t=t.filter(e=>e.rank<=this._include.rank)),this._include.type&&(t=t.filter(e=>0<=this._include.type.indexOf(e.type))),this._include.name)&&(t=t.filter(e=>0<=this._include.name.indexOf(e.name.split("_")[1]))),t}_parseVal(e,t,i,s,r){r=r[e];return r&&r[t]||t}_mergeAugs(e,t,i,_="intersect"){for(var s=[];0<e.length;){let h=e.pop();if("mark"===h.type)if(h.name.endsWith("regression")){var r=t.findIndex(e=>{var t=h.name.split("_"),i=e.name.split("_");return t[1]===i[1]&&"mark"===e.type});r<0&&s.push(h);let n=t.splice(r,1)[0];var r=h.id.split("_"),r=(r[0]=i,r.join("_")),a=h.name.split("_"),a=(a[0]="merged",a.join("_"));let l=this._findLineByLeastSquares;function o(e,t,i,s,r,a){return!(("intersect"!==_||!h._filter(e,t,i,s,r,a)||!n._filter(e,t,i,s,r,a))&&("union"!==_||!h._filter(e,t,i,s,r,a)&&!n._filter(e,t,i,s,r,a))&&("difference"!==_||!h._filter(e,t,i,s,r,a)||n._filter(e,t,i,s,r,a))&&("symmdiff"!==_||!h._filter(e,t,i,s,r,a)&&!n._filter(e,t,i,s,r,a)||h._filter(e,t,i,s,r,a)&&n._filter(e,t,i,s,r,a)))}function u(e,t,i,s,r,a){var e=e.filter(e=>o(e,t,i,s,r,a)),n=e.map(e=>s(e[t])),e=e.map(e=>r(e[i]));return l(n,e)}r=new Aug(r,a,h.type,h.encoding,u,h.styles,h.selection,h.rank).getSpec();r._filter=o,s.push(r)}else if(h.name.endsWith("label")){a=t.findIndex(e=>{var t=h.name.split("_"),i=e.name.split("_");return t[1]===i[1]&&"mark"===e.type});a<0&&s.push(h);let n=t.splice(a,1)[0];var r=h.id.split("_"),d=(r[0]=i,r.join("_")),c=h.name.split("_"),c=(c[0]="merged",c.join("_"));function o(e,t,i,s,r,a){return!(("intersect"!==_||!h._filter(e,t,i,s,r,a)||!n._filter(e,t,i,s,r,a))&&("union"!==_||!h._filter(e,t,i,s,r,a)&&!n._filter(e,t,i,s,r,a))&&("difference"!==_||!h._filter(e,t,i,s,r,a)||n._filter(e,t,i,s,r,a))&&("symmdiff"!==_||!h._filter(e,t,i,s,r,a)&&!n._filter(e,t,i,s,r,a)||h._filter(e,t,i,s,r,a)&&n._filter(e,t,i,s,r,a)))}this._findLineByLeastSquares;let l=this._variable;function m(e,t,i,s,r,a){return e.filter(e=>o(e,t,i,s,r,a)).map(e=>(e.x=s(e[t]),e.y=r(e[i])-15,e.text=""+(l?e[l]:""),e))}d=new Aug(d,c,h.type,h.encoding,m,h.styles,h.selection,h.rank).getSpec();d._filter=o,s.push(d)}else s.push(h);else{c=t.findIndex(e=>{var t=h.name.split("_"),i=e.name.split("_");return t[1]===i[1]&&"encoding"===e.type});if(c<0)s.push(h);else{let n=t.splice(c,1)[0];var d=h.id.split("_"),l=(d[0]=i,d.join("_")),g=h.name.split("_"),g=(g[0]="merged",g.join("_"));function y(e,t,i,s,r,a){return!(("intersect"!==_||!h.generator(e,t,i,s,r,a)||!n.generator(e,t,i,s,r,a))&&("union"!==_||!h.generator(e,t,i,s,r,a)&&!n.generator(e,t,i,s,r,a))&&("difference"!==_||!h.generator(e,t,i,s,r,a)||n.generator(e,t,i,s,r,a))&&("symmdiff"!==_||!h.generator(e,t,i,s,r,a)&&!n.generator(e,t,i,s,r,a)||h.generator(e,t,i,s,r,a)&&n.generator(e,t,i,s,r,a)))}l=new Aug(l,g,h.type,h.encoding,y,h.styles,h.selection,h.rank);s.push(l.getSpec())}}}return s.concat(t).sort(this._sort)}_findLineByLeastSquares(e,t){var i,s,r=0,a=0,n=0,l=0,h=0,_=e.length;if(_!=t.length)throw new Error("The parameters values_x and values_y need to have same size!");if(0===_)return[[],[]];for(var o=0;o<_;o++)r+=i=e[o],a+=s=t[o],l+=i*i,n+=i*s,h++;var u=(h*n-r*a)/(h*l-r*r),d=a/h-u*r/h,[c,m]=extent(e),[u,d]=[c*u+d,m*u+d];return[{x1:c,y1:u,x2:m,y2:d}]}}var markStyles={line:{stroke:"black","stroke-opacity":1,"stroke-width":"1px"},regression:{stroke:"black","stroke-opacity":1,"stroke-width":"1px"},text:{"font-family":"sans-serif","font-size":11},label:{"font-family":"sans-serif","font-size":11,"text-anchor":"middle"},rect:{opacity:.1,fill:"black"},multiple:{"stroke-opacity":.25}},encodingStyles={opacity:{opacity:1},stroke:{stroke:"black","stroke-opacity":1,"stroke-width":"1px"},fill:{fill:"#eb4034"}};class DerivedValues extends GenerationCriteriaBase{constructor(e,t=0,i="add",s,r={}){super(),this._name="DerivedData",this._variable=e,this._type,s?(this._fn=s,this._type="custom"):(this._val=t,this._calc=i,this._type="number"==typeof t?"constant":"variable"),this._customStyles=r}generateMark(n,l,h,_,o){return function(e,t,i,r,a){if(!(t!=n&&i!=n||e.length<1)){let s;return Array.isArray(e[0])?("custom"===h?s=e.map(e=>e.map(e=>[o(e),e[n]])):"constant"===h?"add"===_?s=e.map(e=>e.map(e=>[e[n]+l,e[n]])):"sub"===_?s=e.map(e=>e.map(e=>[e[n]-l,e[n]])):"mult"===_?s=e.map(e=>e.map(e=>[e[n]*l,e[n]])):"div"===_?s=e.map(e=>e.map(e=>[e[n]/l,e[n]])):console.warn(`DerivedValue calc argument ${_} not recognized.`):"add"===_?s=e.map(e=>e.map(e=>[e[n]+e[l],e[n]])):"sub"===_?s=e.map(e=>e.map(e=>[e[n]-e[l],e[n]])):"mult"===_?s=e.map(e=>e.map(e=>[e[n]*e[l],e[n]])):"div"===_?s=e.map(e=>e.map(e=>[e[n]/e[l],e[n]])):console.warn(`DerivedValue calc argument ${_} not recognized.`),s?t==n?e.map((e,i)=>e.map((e,t)=>(e.x=r(s[i][t][0]),e.deltx=r(s[i][t][0])-r(s[i][t][1]),e))):i==n?e.map((e,i)=>e.map((e,t)=>(e.y=a(s[i][t][0]),e.delty=a(s[i][t][0])-a(s[i][t][1]),e))):void 0:void 0):("custom"===h?s=e.map(e=>[o(e),e[n]]):"constant"===h?"add"===_?s=e.map(e=>[e[n]+l,e[n]]):"sub"===_?s=e.map(e=>[e[n]-l,e[n]]):"mult"===_?s=e.map(e=>[e[n]*l,e[n]]):"div"===_?s=e.map(e=>[e[n]/l,e[n]]):console.warn(`DerivedValue calc argument ${_} not recognized.`):"add"===_?s=e.map(e=>[e[n]+e[l],e[n]]):"sub"===_?s=e.map(e=>[e[n]-e[l],e[n]]):"mult"===_?s=e.map(e=>[e[n]*e[l],e[n]]):"div"===_?s=e.map(e=>[e[n]/e[l],e[n]]):console.warn(`DerivedValue calc argument ${_} not recognized.`),s?t==n?e.map((e,t)=>(e.x=r(s[t][0]),e.deltx=r(s[t][0])-r(s[t][1]),e)):i==n?e.map((e,t)=>(e.y=a(s[t][0]),e.delty=a(s[t][0])-a(s[t][1]),e)):void 0:void 0)}}}generateLine(l,h,_,o,u){return function(e,s,r,a,n){if((s==l||r==l)&&!Array.isArray(e[0])){let i,t=s===l?r:s;if("custom"===_?i=e.map(e=>[u(e),e[l],e[t]]):"constant"===_?"add"===o?i=e.map(e=>[e[l]+h,e[l],e[t]]):"sub"===o?i=e.map(e=>[e[l]-h,e[l],e[t]]):"mult"===o?i=e.map(e=>[e[l]*h,e[l],e[t]]):"div"===o?i=e.map(e=>[e[l]/h,e[l],e[t]]):console.warn(`DerivedValue calc argument ${o} not recognized.`):"add"===o?i=e.map(e=>[e[l]+e[h],e[l],e[t]]):"sub"===o?i=e.map(e=>[e[l]-e[h],e[l],e[t]]):"mult"===o?i=e.map(e=>[e[l]*e[h],e[l],e[t]]):"div"===o?i=e.map(e=>[e[l]/e[h],e[l],e[t]]):console.warn(`DerivedValue calc argument ${o} not recognized.`),i)return s===l?e.map((e,t)=>(e.x1=a(i[t][0]),e.x2=a(i[t][1]),e.y1=n(i[t][2]),e.y2=n(i[t][2]),e)):r==l?e.map((e,t)=>(e.y1=n(i[t][0]),e.y2=n(i[t][1]),e.x1=a(i[t][2]),e.x2=a(i[t][2]),e)):void 0}}}generateAxis(n,l,h,_,o){return function(e,i,s,r,a){if(i==n||s==n){let t;if("custom"===h?t=e.map(e=>o(e[n])):"constant"===h?"add"===_?t=e.map(e=>e[n]+l):"sub"===_?t=e.map(e=>e[n]-l):"mult"===_?t=e.map(e=>e[n]*l):"div"===_?t=e.map(e=>e[n]/l):console.warn(`DerivedValue calc argument ${_} not recognized.`):"add"===_?t=e.map(e=>e[n]+e[l]):"sub"===_?t=e.map(e=>e[n]-e[l]):"mult"===_?t=e.map(e=>e[n]*e[l]):"div"===_?t=e.map(e=>e[n]/e[l]):console.warn(`DerivedValue calc argument ${_} not recognized.`),t){let e;return i===n?{x:e=extent(t),y:a.domain()}:s==n?(e=extent(t),{x:r.domain(),y:e}):void 0}}}}getAugs(){var e=new Aug(this._id+"_multiple","derived_multiple","mark",{mark:void 0},this.generateMark(this._variable,this._val,this._type,this._calc,this._fn),this.mergeStyles(this._customStyles.multiple,markStyles.multiple),this._selection,1),t=new Aug(this._id+"_line","derived_line","mark",{mark:"line"},this.generateLine(this._variable,this._val,this._type,this._calc,this._fn),this.mergeStyles(this._customStyles.line,markStyles.line),this._selection,2);return this._filter([e.getSpec(),t.getSpec()]).sort(this._sort)}updateVariable(e){this._variable=e}updateVal(e){this._val=e}updateFunction(e){this._fn=e}}class Emphasis extends GenerationCriteriaBase{constructor(e,t,i=0,s={}){super(),this._name="Emphasis",this._variable=e,this._val=t,this._customStyles=s}_generator(h,_,o){let u=this._parseVal;return function(e,t,i,s,r,a){if(!h||!_)return!0;let n;function l(e){return Array.isArray(n)?0<=n.indexOf(e):e==n}return n=Array.isArray(_)?_.map(e=>u(h,e,t,i,a)):u(h,_,t,i,a),Array.isArray(e)?"any"===o?e.reduce((e,t)=>e||l(t[h]),!1):e.reduce((e,t)=>e&&l(t[h]),!0):l(e[h])}}generateLinearRegression(e,t,i){let l=this._findLineByLeastSquares,h=this._generator(e,t,i);return function(e,t,i,s,r,a){var e=e.filter(e=>h(e,t,i,s,r,a)),n=e.map(e=>s(e[t])),e=e.map(e=>r(e[i]));return l(n,e)}}generateLabel(n,e,t,i){let l=this._generator(n,e,t);return function(e,t,i,s,r,a){return e.filter(e=>l(e,t,i,s,r,a)).map(e=>(e.x=s(e[t]),e.y=r(e[i])-15,e.text=""+e[n],e))}}getAugs(){var e=new Aug(this._id+"_stroke","emphasis_stroke","encoding",void 0,this._generator(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.stroke,encodingStyles.stroke),this._selection,1),t=new Aug(this._id+"_text","emphasis_label","mark",{mark:"text"},this.generateLabel(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.label,markStyles.label),this._selection,3),i=new Aug(this._id+"_fill","emphasis_fill","encoding",void 0,this._generator(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.fill,encodingStyles.fill),this._selection,4),s=new Aug(this._id+"_opacity","emphasis_opacity","encoding",void 0,this._generator(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.opacity,encodingStyles.opacity),this._selection,2),r=new Aug(this._id+"_regression","emphasis_regression","mark",{mark:"line"},this.generateLinearRegression(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.regression,markStyles.line),this._selection,5),t=t.getSpec(),r=(t._filter=this._generator(this._variable,this._val,this._type),r.getSpec());return r._filter=this._generator(this._variable,this._val,this._type),this._filter([e.getSpec(),t,i.getSpec(),s.getSpec(),r]).sort(this._sort)}updateVariable(e){this._variable=e}updateVal(e){this._val=e}intersect(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i));return s}union(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i,"union"));return s}symmdiff(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i,"symmdiff"));return s}}class LocalData extends GenerationCriteriaBase{constructor(e,t={}){super(),this._name="LocalData",this._local=e,this._customStyles=t}generateMark(a=[]){return function(e,t,i,s,r){return a.map(e=>(e.x=s(e[t]),e.y=r(e[i]),e))}}getAugs(){var e=new Aug(this._id+"_mark","local_mark","mark",{mark:void 0},this.generateMark(this._local),this.mergeStyles(this._customStyles.mark,void 0),this._selection,1);return this._filter([e.getSpec()]).sort(this._sort)}updateVariable(e){return this._variable=e,this}updateVal(e){return this._val=e,this}updateFunction(e){return this._fn=e,this}}class Range extends GenerationCriteriaBase{constructor(e,t,i="closed",s={}){super(),this._name="Range",this._variable=e,this._min=t[0],this._max=t[1],this._type=i,this._customStyles=s}_generator(n,l,h,_){let o=this._parseVal;return function(e,t,r,i,s,a){if(t==n||r==n){let i=o(n,l,t,r,a),s=o(n,h,t,r,a);if(!(i>s))if(Array.isArray(e)){if("closed"===_)return e.reduce((e,t)=>e&&t[n]>=i&&t[n]<=s,!0);if("open"===_)return e.reduce((e,t)=>e&&t[n]>i&&t[n]<s,!0)}else{if("closed"===_&&e[n]>=i&&e[n]<=s)return!0;if("open"===_&&e[n]>i&&e[n]<s)return!0}}return!1}}generateRect(l,h,_,e){let o=this._parseVal;return function(e,t,i,s,r,a){var n;return t!=l&&i!=l?[]:(n=o(l,h,t,i,a),!((a=o(l,_,t,i,a))<n)&&(t==l?[{x:min([s(n),s(a)]),width:Math.abs(s(a)-s(n)),y:min([r.range()[1],r.range()[0]]),height:Math.abs(r.range()[1]-r.range()[0])}]:i==l?[{x:min([s.range()[0],s.range()[1]]),width:Math.abs(s.range()[1]-s.range()[0]),y:min([r(n),r(a)]),height:Math.abs(r(a)-r(n))}]:[]))}}generateLinearRegression(e,t,i,s){let l=this._findLineByLeastSquares,h=this._generator(e,t,i,s);return function(e,t,i,s,r,a){var e=e.filter(e=>h(e,t,i,s,r,a)),n=e.map(e=>s(e[t])),e=e.map(e=>r(e[i]));return l(n,e)}}generateText(l,h,_,e){let o=this._parseVal;return function(e,t,i,s,r,a){var n;return!(t!=l&&i!=l||(n=o(l,h,t,i,a),(a=o(l,_,t,i,a))<n))&&(t==l?[{x:s(n)+5,y:r.range()[1],text:`  ${n} `+(h!=n?"("+h+")":"")},{x:s(a)+5,y:r.range()[1],text:`  ${a} `+(_!=a?"("+_+")":"")}]:i==l?[{x:s.range()[0],y:r(n)-5,text:`  ${n} `+(h!=n?"("+h+")":"")},{x:s.range()[0],y:r(a)+5,text:`  ${a} `+(_!=a?"("+_+")":"")}]:void 0)}}generateLabel(n,e,t,i,s){let l=this._generator(n,e,t,i);return function(e,t,i,s,r,a){return e.filter(e=>l(e,t,i,s,r,a)).map(e=>(e.x=s(e[t]),e.y=r(e[i])-15,e.text=""+e[n],e))}}getAugs(){var e=new Aug(this._id+"_rect","range_rect","mark",{mark:"rect"},this.generateRect(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.rect,markStyles.rect),this._selection,1),t=new Aug(this._id+"_opacity","range_opacity","encoding",void 0,this._generator(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.opacity,encodingStyles.opacity),this._selection,2),i=new Aug(this._id+"_stroke","range_stroke","encoding",void 0,this._generator(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.stroke,encodingStyles.stroke),this._selection,3),s=new Aug(this._id+"_fill","range_fill","encoding",void 0,this._generator(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.fill,encodingStyles.fill),this._selection,4),r=new Aug(this._id+"_text","range_text","mark",{mark:"text"},this.generateText(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.text,markStyles.text),this._selection,1),a=new Aug(this._id+"_label","range_label","mark",{mark:"text"},this.generateLabel(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.label,markStyles.label),this._selection,5),n=new Aug(this._id+"_regression","range_regression","mark",{mark:"line"},this.generateLinearRegression(this._variable,this._min,this._max,this._type),this.mergeStyles(this._customStyles.regression,markStyles.line),this._selection,6),a=a.getSpec(),n=(a._filter=this._generator(this._variable,this._min,this._max,this._type),n.getSpec());return n._filter=this._generator(this._variable,this._min,this._max,this._type),this._filter([e.getSpec(),t.getSpec(),i.getSpec(),s.getSpec(),r.getSpec(),a,n]).sort(this._sort)}updateVariable(e){return this._variable=e,this}updateVal(e){return this._min=e[0],this._max=e[1],this}updateType(e){return this._type=e,this}intersect(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i));return s}union(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i,"union"));return s}symmdiff(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i,"symmdiff"));return s}}class Regression extends GenerationCriteriaBase{constructor(e={}){super(),this._name="Regression",this._customStyles=e}findLineByLeastSquares(e,t){var i,s,r=0,a=0,n=0,l=0,h=0,_=e.length;if(_!=t.length)throw new Error("The parameters values_x and values_y need to have same size!");if(0===_)return[[],[]];for(var o=0;o<_;o++)r+=i=e[o],a+=s=t[o],l+=i*i,n+=i*s,h++;var u=(h*n-r*a)/(h*l-r*r),d=a/h-u*r/h,[c,m]=extent(e),[u,d]=[c*u+d,m*u+d];return[[c,u],[m,d]]}generateLine(){let n=this.findLineByLeastSquares;return function(e,t,i,s,r){var a=e.map(e=>s(e[t])),e=e.map(e=>r(e[i])),a=n(a,e);return[{x1:a[0][0],y1:a[0][1],x2:a[1][0],y2:a[1][1]}]}}getAugs(){var e=new Aug(this._id+"_line","regression_line","mark",{mark:"line"},this.generateLine(),this.mergeStyles(this._customStyles.regression,markStyles.regression),this._selection,1);return this._filter([e.getSpec()]).sort(this._sort)}}class Threshold extends GenerationCriteriaBase{constructor(e,t,i="eq",s={}){super(),this._name="Threshold",this._variable=e,this._val=t,this._type=i,this._customStyles=s}_generator(l,h,_){let o=this._parseVal;return function(e,t,i,s,r,a){let n=o(l,h,t,i,a);if(Array.isArray(e)){if("eq"===_)return e.reduce((e,t)=>e&&t[l]==n,!0);if("le"===_)return e.reduce((e,t)=>e&&t[l]<n,!0);if("leq"===_)return e.reduce((e,t)=>e&&t[l]<=n,!0);if("ge"===_)return e.reduce((e,t)=>e&&t[l]>n,!0);if("geq"===_)return e.reduce((e,t)=>e&&t[l]>=n,!0)}else{if("eq"===_&&e[l]==n)return!0;if("le"===_&&e[l]<n)return!0;if("leq"===_&&e[l]<=n)return!0;if("ge"===_&&e[l]>n)return!0;if("geq"===_&&e[l]>=n)return!0}return!1}}generateLine(n,l,e){let h=this._parseVal;return function(e,t,i,s,r,a){return(t==n||i==n)&&(a=h(n,l,t,i,a),t==n?[{x1:s(a),x2:s(a),y1:r.range()[0],y2:r.range()[1]}]:i==n?[{x1:s.range()[0],x2:s.range()[1],y1:r(a),y2:r(a)}]:void 0)}}generateLinearRegression(e,t,i){let l=this._findLineByLeastSquares,h=this._generator(e,t,i);return function(e,t,i,s,r,a){var e=e.filter(e=>h(e,t,i,s,r,a)),n=e.map(e=>s(e[t])),e=e.map(e=>r(e[i]));return l(n,e)}}generateText(n,l,h){let _=this._parseVal;return function(e,t,i,s,r,a){return(t==n||i==n)&&(a=_(n,l,t,i,a),"le"===h||"leq"===h?t==n?[{anchor:"middle",x:s(a),y:r.range()[1]-10,text:`  ${"le"==h?"<":"<="} ${a} `+(l!=a?"("+l+")":"")}]:i==n?[{x:s.range()[0],y:r(a)+10,text:`  ${"le"==h?"<":"<="} ${a} `+(l!=a?"("+l+")":"")}]:void 0:"ge"===h||"geq"===h?t==n?[{anchor:"middle",x:s(a),y:r.range()[1]-10,text:`  ${"ge"==h?">":">="} ${a} `+(l!=a?"("+l+")":"")}]:i==n?[{x:s.range()[0],y:r(a)-10,text:`  ${"ge"==h?">":">="} ${a} `+(l!=a?"("+l+")":"")}]:void 0:t==n?[{anchor:"middle",x:s(a),y:r.range()[1]-10,text:`  ${a} `+(l!=a?"("+l+")":"")}]:i==n?[{x:s.range()[0],y:r(a)-10,text:`  ${a} `+(l!=a?"("+l+")":"")}]:void 0)}}generateLabel(n,e,t,i){let l=this._generator(n,e,t);return function(e,t,i,s,r,a){return e.filter(e=>l(e,t,i,s,r,a)).map(e=>(e.x=s(e[t]),e.y=r(e[i])-15,e.text=""+e[n],e))}}getAugs(){var e=new Aug(this._id+"_line","threshold_line","mark",{mark:"line"},this.generateLine(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.line,markStyles.line),this._selection,1),t=new Aug(this._id+"_opacity","threshold_opacity","encoding",void 0,this._generator(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.opacity,encodingStyles.opacity),this._selection,2),i=new Aug(this._id+"_stroke","threshold_stroke","encoding",void 0,this._generator(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.stroke,encodingStyles.stroke),this._selection,3),s=new Aug(this._id+"_fill","threshold_fill","encoding",void 0,this._generator(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.fill,encodingStyles.fill),this._selection,4),r=new Aug(this._id+"_label","threshold_label","mark",{mark:"text"},this.generateLabel(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.label,markStyles.label),this._selection,5),a=new Aug(this._id+"_text","threshold_text","mark",{mark:"text"},this.generateText(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.text,markStyles.text),this._selection,1),n=new Aug(this._id+"_regression","threshold_regression","mark",{mark:"line"},this.generateLinearRegression(this._variable,this._val,this._type),this.mergeStyles(this._customStyles.regression,markStyles.line),this._selection,6),r=r.getSpec(),n=(r._filter=this._generator(this._variable,this._val,this._type),n.getSpec());return n._filter=this._generator(this._variable,this._val,this._type),this._filter([e.getSpec(),t.getSpec(),i.getSpec(),s.getSpec(),a.getSpec(),r,n]).sort(this._sort)}updateVariable(e){return this._variable=e,this}updateVal(e){return this._val=e,this}updateType(e){return this._type=e,this}intersect(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i));return s}union(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i,"union"));return s}symmdiff(e){let t=e,i=(Array.isArray(e)||(t=[e]),this._id),s=this.getAugs();for(var r of t)(r._name.startsWith("Threshold")||r._name.startsWith("Emphasis")||r._name.startsWith("Range"))&&(i=i+"-"+r._id,r=r.getAugs(),s=this._mergeAugs(s,r,i,"symmdiff"));return s}}export{DerivedValues,Draft,Emphasis,LocalData,Range,Regression,Threshold};